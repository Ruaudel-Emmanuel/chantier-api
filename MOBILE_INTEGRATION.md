# ============================================================================\n# GUIDE D'INTÃ‰GRATION MOBILE\n# Pour applications React Native, Flutter, ou webapp mobile\n# ============================================================================\n\n## ðŸŽ¯ Objectif\n\nCe guide explique comment intÃ©grer l'API \"Gestion des Chantiers\" dans une application mobile.\n\n**Cas d'usage principal :** Chef de chantier sur le terrain qui :\n- âœ… RÃ©cupÃ¨re ses tÃ¢ches du jour\n- âœ… Enregistre les heures travaillÃ©es\n- âœ… Prend des photos avec gÃ©olocalisation\n- âœ… Signale des anomalies/problÃ¨mes\n- âœ… Consulte le rapport d'avancement en temps rÃ©el\n\n---\n\n## ðŸ”‘ Points clÃ©s de l'intÃ©gration\n\n### 1. Authentification par Token\n\nL'API utilise des tokens Bearer. Workflow :\n\n```\n1. Utilisateur se connecte avec username/password\n2. API retourne un token unique\n3. Le token est sauvegardÃ© localement (AsyncStorage, Secure Storage)\n4. Chaque requÃªte inclut : Authorization: Token XXX\n5. Token persiste aprÃ¨s fermeture de l'app\n```\n\n### 2. Synchronisation hors-ligne\n\nL'API est conÃ§ue pour supporter une synchronisation hors-ligne :\n- LocalStorage/SQLite pour les donnÃ©es\n- Queue de synchronisation\n- Conflict resolution\n\n---\n\n## ðŸ“± IntÃ©gration React Native\n\n### Installation\n\n```bash\nnpm install axios @react-native-async-storage/async-storage react-native-geolocation-service\n```\n\n### Fichier de configuration API\n\n```javascript\n// api/client.js\nimport axios from 'axios';\nimport AsyncStorage from '@react-native-async-storage/async-storage';\n\nconst API_BASE_URL = 'https://api.chantiers.com/api/v1';\n\nconst client = axios.create({\n  baseURL: API_BASE_URL,\n  timeout: 10000,\n});\n\n// Interceptor : Ajouter token Ã  chaque requÃªte\nclient.interceptors.request.use(\n  async (config) => {\n    const token = await AsyncStorage.getItem('authToken');\n    if (token) {\n      config.headers.Authorization = `Token ${token}`;\n    }\n    return config;\n  },\n  (error) => Promise.reject(error)\n);\n\n// Interceptor : GÃ©rer les erreurs 401\nclient.interceptors.response.use(\n  (response) => response,\n  async (error) => {\n    if (error.response?.status === 401) {\n      // Token expirÃ© ou invalide\n      await AsyncStorage.removeItem('authToken');\n      // Rediriger vers login\n    }\n    return Promise.reject(error);\n  }\n);\n\nexport default client;\n```\n\n### Authentification\n\n```javascript\n// api/auth.js\nimport client from './client';\nimport AsyncStorage from '@react-native-async-storage/async-storage';\n\nexport const login = async (username, password) => {\n  try {\n    const response = await client.post('/auth/token/', {\n      username,\n      password\n    });\n    \n    const { token } = response.data;\n    await AsyncStorage.setItem('authToken', token);\n    await AsyncStorage.setItem('username', username);\n    \n    return { success: true };\n  } catch (error) {\n    return { \n      success: false, \n      error: error.response?.data?.detail || 'Login failed' \n    };\n  }\n};\n\nexport const logout = async () => {\n  await AsyncStorage.removeItem('authToken');\n  await AsyncStorage.removeItem('username');\n};\n```\n\n### RÃ©cupÃ©rer les tÃ¢ches du jour\n\n```javascript\n// api/taches.js\nimport client from './client';\n\nexport const getTachesChantier = async (chantierId, filters = {}) => {\n  try {\n    const response = await client.get('/taches/', {\n      params: {\n        lot__chantier__id: chantierId,\n        status__in: ['A_FAIRE', 'EN_COURS'],\n        ...filters\n      }\n    });\n    return response.data.results;\n  } catch (error) {\n    console.error('Error fetching taches:', error);\n    throw error;\n  }\n};\n```\n\n### Enregistrer des heures (Point focal)\n\n```javascript\n// api/heures.js\nimport client from './client';\nimport * as Location from 'expo-location';\n\nexport const enregistrerHeures = async (tacheId, heures, description) => {\n  try {\n    // RÃ©cupÃ©rer la gÃ©olocalisation\n    const location = await Location.getCurrentPositionAsync({});\n    const { latitude, longitude } = location.coords;\n    \n    const response = await client.post(\n      `/taches/${tacheId}/heures/`,\n      {\n        membre: null,  // Ou obtenir depuis le contexte utilisateur\n        heures: parseFloat(heures),\n        description,\n        latitude,\n        longitude,\n        date: new Date().toISOString().split('T')[0]\n      }\n    );\n    \n    return response.data;\n  } catch (error) {\n    console.error('Error saving heures:', error);\n    throw error;\n  }\n};\n```\n\n### Upload de photo\n\n```javascript\n// api/photos.js\nimport client from './client';\nimport * as ImagePicker from 'expo-image-picker';\nimport * as Location from 'expo-location';\n\nexport const uploadPhoto = async (tacheId, photoUri, titre, description) => {\n  try {\n    // RÃ©cupÃ©rer la gÃ©olocalisation\n    const location = await Location.getCurrentPositionAsync({});\n    const { latitude, longitude } = location.coords;\n    \n    // CrÃ©er FormData\n    const formData = new FormData();\n    formData.append('image', {\n      uri: photoUri,\n      type: 'image/jpeg',\n      name: `photo_${Date.now()}.jpg`\n    });\n    formData.append('titre', titre);\n    formData.append('description', description);\n    formData.append('latitude', latitude);\n    formData.append('longitude', longitude);\n    \n    const response = await client.post(\n      `/taches/${tacheId}/photo/`,\n      formData,\n      {\n        headers: {\n          'Content-Type': 'multipart/form-data'\n        }\n      }\n    );\n    \n    return response.data;\n  } catch (error) {\n    console.error('Error uploading photo:', error);\n    throw error;\n  }\n};\n```\n\n### Screen exemple : Enregistrement d'heures\n\n```javascript\n// screens/EnregistrerHeuresScreen.js\nimport React, { useState, useEffect } from 'react';\nimport {\n  View,\n  TextInput,\n  Button,\n  ActivityIndicator,\n  Text,\n  Alert\n} from 'react-native';\nimport { enregistrerHeures } from '../api/heures';\n\nconst EnregistrerHeuresScreen = ({ route, navigation }) => {\n  const { tacheId, tacheNom } = route.params;\n  const [heures, setHeures] = useState('');\n  const [description, setDescription] = useState('');\n  const [loading, setLoading] = useState(false);\n  \n  const handleSave = async () => {\n    if (!heures || parseFloat(heures) <= 0) {\n      Alert.alert('Erreur', 'Entrez un nombre d\\'heures positif');\n      return;\n    }\n    \n    setLoading(true);\n    try {\n      await enregistrerHeures(tacheId, heures, description);\n      Alert.alert('SuccÃ¨s', 'Heures enregistrÃ©es');\n      navigation.goBack();\n    } catch (error) {\n      Alert.alert('Erreur', error.message);\n    } finally {\n      setLoading(false);\n    }\n  };\n  \n  return (\n    <View style={{ padding: 16, flex: 1 }}>\n      <Text style={{ fontSize: 18, fontWeight: 'bold', marginBottom: 16 }}>\n        {tacheNom}\n      </Text>\n      \n      <TextInput\n        placeholder=\"Nombre d'heures\"\n        keyboardType=\"decimal-pad\"\n        value={heures}\n        onChangeText={setHeures}\n        style={{ borderWidth: 1, borderColor: '#ccc', padding: 10, marginBottom: 16 }}\n      />\n      \n      <TextInput\n        placeholder=\"Description (optionnel)\"\n        value={description}\n        onChangeText={setDescription}\n        style={{ borderWidth: 1, borderColor: '#ccc', padding: 10, marginBottom: 16, height: 100 }}\n        multiline\n      />\n      \n      {loading ? (\n        <ActivityIndicator size=\"large\" color=\"#007AFF\" />\n      ) : (\n        <Button title=\"Enregistrer\" onPress={handleSave} />\n      )}\n    </View>\n  );\n};\n\nexport default EnregistrerHeuresScreen;\n```\n\n---\n\n## ðŸš€ IntÃ©gration Flutter\n\n### DÃ©pendances (pubspec.yaml)\n\n```yaml\ndependencies:\n  flutter:\n    sdk: flutter\n  dio: ^4.0.6\n  geolocator: ^9.0.2\n  image_picker: ^0.8.7\n  intl: ^0.18.0\n```\n\n### Service API\n\n```dart\n// lib/services/api_client.dart\nimport 'package:dio/dio.dart';\nimport 'package:flutter_secure_storage/flutter_secure_storage.dart';\n\nclass ApiClient {\n  static const String baseUrl = 'https://api.chantiers.com/api/v1';\n  late Dio _dio;\n  final storage = FlutterSecureStorage();\n  \n  ApiClient() {\n    _dio = Dio(BaseOptions(baseUrl: baseUrl));\n    _dio.interceptors.add(InterceptorsWrapper(\n      onRequest: (options, handler) async {\n        final token = await storage.read(key: 'authToken');\n        if (token != null) {\n          options.headers['Authorization'] = 'Token $token';\n        }\n        return handler.next(options);\n      },\n      onError: (error, handler) async {\n        if (error.response?.statusCode == 401) {\n          await storage.delete(key: 'authToken');\n          // Rediriger vers login\n        }\n        return handler.next(error);\n      },\n    ));\n  }\n  \n  Future<Response> getTaches(int chantierId) {\n    return _dio.get(\n      '/taches/',\n      queryParameters: {\n        'lot__chantier__id': chantierId,\n        'status__in': ['A_FAIRE', 'EN_COURS'],\n      },\n    );\n  }\n  \n  Future<Response> enregistrerHeures(\n    int tacheId,\n    double heures,\n    double latitude,\n    double longitude,\n  ) {\n    return _dio.post(\n      '/taches/$tacheId/heures/',\n      data: {\n        'heures': heures,\n        'latitude': latitude,\n        'longitude': longitude,\n        'date': DateTime.now().toString().split(' ')[0],\n      },\n    );\n  }\n}\n```\n\n---\n\n## ðŸ”„ Synchronisation hors-ligne\n\n### Architecture recommandÃ©e\n\n```\nâ”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”\nâ”‚  App Mobile         â”‚\nâ”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚\nâ”‚  â”‚  Local Store  â”‚  â”‚  (SQLite / Realm)\nâ”‚  â”‚  (donnÃ©es)    â”‚  â”‚\nâ”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚\nâ”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚\nâ”‚  â”‚  Sync Queue   â”‚  â”‚  (Actions Ã  synchroniser)\nâ”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚\nâ””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜\n        â†“ (when online)\nâ”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”\nâ”‚  API Backend        â”‚\nâ””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜\n```\n\n### ImplÃ©mentation (React Native)\n\n```javascript\n// Sync service\nclass SyncService {\n  async syncQueue() {\n    const queue = await AsyncStorage.getItem('syncQueue');\n    const actions = queue ? JSON.parse(queue) : [];\n    \n    for (const action of actions) {\n      try {\n        switch (action.type) {\n          case 'SAVE_HEURES':\n            await enregistrerHeures(\n              action.data.tacheId,\n              action.data.heures,\n              action.data.description\n            );\n            break;\n          case 'SAVE_PHOTO':\n            await uploadPhoto(\n              action.data.tacheId,\n              action.data.photoUri,\n              action.data.titre\n            );\n            break;\n        }\n        // Retirer de la queue\n        actions.shift();\n      } catch (error) {\n        console.error('Sync error:', error);\n        break;  // RÃ©essayer plus tard\n      }\n    }\n    \n    await AsyncStorage.setItem('syncQueue', JSON.stringify(actions));\n  }\n}\n```\n\n---\n\n## ðŸ” SÃ©curitÃ© Mobile\n\nâœ… **Ã€ faire :**\n- Stocker le token dans Secure Storage, pas AsyncStorage\n- Valider SSL/TLS en production\n- ImplÃ©menter Token Refresh\n- GÃ©rer les sessions\n- Limiter les timeouts\n\nâŒ **Ã€ ne pas faire :**\n- Stocker le password\n- DÃ©sactiver la vÃ©rification SSL\n- Envoyer le token en URL\n- Logguer les donnÃ©es sensibles\n\n---\n\n## ðŸ“Š Performance\n\n### Pagination\n```javascript\nconst getTachesPage = async (page = 1) => {\n  const response = await client.get('/taches/', {\n    params: { page, page_size: 20 }\n  });\n  return response.data;\n};\n```\n\n### Lazy Loading des Images\n```javascript\n// Charger les photos Ã  la demande, pas toutes d'un coup\nconst getTachesLight = async () => {\n  return client.get('/taches/?exclude=photos');\n};\n```\n\n---\n\n## ðŸ§ª Tester l'intÃ©gration\n\n### Postman\n1. Importer la collection depuis `/docs/postman_collection.json`\n2. Configurer les variables d'environnement\n3. Tester chaque endpoint\n\n### CLI\n```bash\n# Login et rÃ©cupÃ©rer token\nTOKEN=$(curl -s -X POST http://localhost:8000/api/v1/auth/token/ \\\n  -H \"Content-Type: application/json\" \\\n  -d '{\"username\":\"user\",\"password\":\"pass\"}' | jq -r '.token')\n\n# Tester endpoint\ncurl -X GET http://localhost:8000/api/v1/chantiers/ \\\n  -H \"Authorization: Token $TOKEN\"\n```\n\n---\n\n## ðŸ“š Resources\n\n- [React Native Docs](https://reactnative.dev/)\n- [Flutter Docs](https://flutter.dev/docs)\n- [Axios](https://axios-http.com/)\n- [Dio (Flutter HTTP)](https://pub.dev/packages/dio)\n- [Geolocation](https://developer.mozilla.org/en-US/docs/Web/API/Geolocation_API)\n\n---\n\n**Support :** Pour les questions, consultez `/docs/API_DOCUMENTATION.md`\n